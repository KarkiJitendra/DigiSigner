<!-- templates/admin/add_api_token.html -->
{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/api_generate.css' %}">
{% endblock %}

{% block extrahead %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="add-api-token-container">
    <!-- Header Section -->
    <div class="token-header">
        <div class="header-left">
            <h1>
                <i class="fas fa-key"></i>
                Generate New API Token
            </h1>
            <p class="subtitle">Create a secure API token for accessing RCertVault services</p>
        </div>
        <div class="header-right">
            <div class="token-preview">
                <div class="token-preview-label">Token Preview</div>
                <code class="token-preview-value">generated-on-save</code>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <form id="apiTokenForm" method="post" novalidate>
        {% csrf_token %}
        
        <div class="form-container">
            <!-- Section 1: Basic Details -->
            <div class="form-section">
                <div class="section-header">
                    <h2><i class="fas fa-info-circle"></i> Token Details</h2>
                </div>
                
                <div class="form-grid two-col">
                    <!-- Organization -->
                    <div class="form-group">
                        <label for="id_organization">
                            <i class="fas fa-building"></i> Organization
                        </label>
                        <select id="id_organization" name="organization" class="form-select">
                            <option value="">-- Global (All Organizations) --</option>
                            <option value="nepal-insurance" selected>Nepal Insurance Authority</option>
                            <!-- Context would populate real orgs here -->
                        </select>
                    </div>

                    <!-- User (if admin) -->
                    <div class="form-group">
                        <label for="id_user">
                            <i class="fas fa-user"></i> User
                        </label>
                        <select id="id_user" name="user" class="form-select" disabled>
                            <option value="{{ request.user.id }}" selected>{{ request.user.username }}</option>
                        </select>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group full-width">
                    <label for="id_description">
                        <i class="fas fa-align-left"></i> Description <span class="required">*</span>
                    </label>
                    <textarea id="id_description" name="description" 
                              class="form-textarea" 
                              placeholder="e.g., Production server access for PDF signing"
                              rows="2" required></textarea>
                    <div class="char-counter">
                        <span id="charCount">0</span>/200
                    </div>
                </div>
            </div>

            <!-- Section 2: Expiry -->
            <div class="form-section">
                <div class="section-header">
                    <h2><i class="fas fa-clock"></i> Expiry Settings</h2>
                </div>

                <div class="expiry-options-row">
                    <label class="radio-card">
                        <input type="radio" name="expiry_option" value="7" checked>
                        <span class="card-content">7 Days</span>
                    </label>
                    <label class="radio-card">
                        <input type="radio" name="expiry_option" value="30">
                        <span class="card-content">30 Days</span>
                    </label>
                    <label class="radio-card">
                        <input type="radio" name="expiry_option" value="90">
                        <span class="card-content">90 Days</span>
                    </label>
                    <label class="radio-card">
                        <input type="radio" name="expiry_option" value="365">
                        <span class="card-content">1 Year</span>
                    </label>
                    <label class="radio-card">
                        <input type="radio" name="expiry_option" value="custom">
                        <span class="card-content">Custom</span>
                    </label>
                </div>

                <div class="custom-expiry-container" id="customExpiryContainer" style="display: none;">
                    <div class="date-time-picker-row">
                        <div class="picker-group">
                            <label>Date</label>
                            <div class="input-with-icon">
                                <input type="text" id="custom_date" class="picker-input" placeholder="Select Date" disabled>
                                <button type="button" class="icon-btn" id="dateBtn"><i class="fas fa-calendar-alt"></i></button>
                            </div>
                        </div>
                        <div class="picker-group">
                            <label>Time</label>
                            <div class="input-with-icon">
                                <input type="text" id="custom_time" class="picker-input" placeholder="Select Time" disabled>
                                <button type="button" class="icon-btn" id="timeBtn"><i class="fas fa-clock"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="expiry-preview-bar">
                    <i class="fas fa-info-circle"></i>
                    <span>Token expires on: <strong id="expiryPreview">Calculating...</strong></span>
                </div>
            </div>

            <!-- Section 3: Permissions -->
            <div class="form-section">
                <div class="section-header">
                    <h2><i class="fas fa-shield-alt"></i> Permissions</h2>
                    <label class="checkbox-label select-all">
                        <input type="checkbox" id="selectAllPerms">
                        <span class="checkmark"></span> Select All
                    </label>
                </div>

                <div class="permissions-checklist">
                    <!-- PDF Group -->
                    <div class="perm-category">
                        <h3>PDF Operations</h3>
                        <div class="perm-items">
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="pdf_sign">
                                <span class="checkmark"></span>
                                <span class="perm-text">Sign PDF Documents</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="pdf_verify">
                                <span class="checkmark"></span>
                                <span class="perm-text">Verify PDF Signatures</span>
                            </label>
                        </div>
                    </div>

                    <!-- Form Group -->
                    <div class="perm-category">
                        <h3>Form Operations</h3>
                        <div class="perm-items">
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="form_sign">
                                <span class="checkmark"></span>
                                <span class="perm-text">Sign Electronic Forms</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="form_verify">
                                <span class="checkmark"></span>
                                <span class="perm-text">Verify Form Signatures</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Admin Group -->
                    <div class="perm-category">
                        <h3>Administrative</h3>
                        <div class="perm-items">
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="read_logs">
                                <span class="checkmark"></span>
                                <span class="perm-text">Read Audit Logs</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="generateBtn">
                    <i class="fas fa-key"></i> Generate Token
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Generated Token Modal -->
<div class="modal" id="tokenModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-check-circle"></i> Token Generated</h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p class="modal-intro">Your new API token is ready. <strong>Copy it now</strong>, you won't see it again.</p>
            
            <div class="token-display-box">
                <code id="generatedToken">...</code>
                <button class="btn-icon copy-token-btn" id="modalCopyBtn">
                    <i class="far fa-copy"></i>
                </button>
            </div>
            
            <div class="token-summary">
                <div class="summary-item">
                    <span class="label">Description:</span>
                    <span class="value" id="modalDescription">-</span>
                </div>
                <div class="summary-item">
                    <span class="label">Expires:</span>
                    <span class="value" id="modalExpiry">-</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="{% url 'api_token' %}" class="btn btn-primary">Done</a>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% static 'js/apikey_generate.js' %}"></script>
{% endblock %}
{% endblock %}